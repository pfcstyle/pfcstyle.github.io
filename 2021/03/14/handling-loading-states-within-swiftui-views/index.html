<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>Loading states of SwiftUI views &mdash; 01手记</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/pfcstyle/pfcstyle.github.io@master/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/pfcstyle/pfcstyle.github.io@master/assets/css/components/collection.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/pfcstyle/pfcstyle.github.io@master/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/pfcstyle/pfcstyle.github.io@master/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/pfcstyle/pfcstyle.github.io@master/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/pfcstyle/pfcstyle.github.io@master/assets/css/globals/common.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/pfcstyle/pfcstyle.github.io@master/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/pfcstyle/pfcstyle.github.io@master/assets/css/posts/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/pfcstyle/pfcstyle.github.io@master/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mzlogin/rouge-themes@master/dist/github.css"><link rel="canonical" href="https://pfcstyle.github.io/2021/03/14/handling-loading-states-within-swiftui-views/"><link rel="alternate" type="application/atom+xml" title="01手记" href="https://pfcstyle.github.io/feed.xml"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/pfcstyle/pfcstyle.github.io@master/favicon.ico"><meta property="og:title" content="Loading states of SwiftUI views"><meta name="keywords" content="["SwiftUI", "iOS", "Combine"]"><meta name="og:keywords" content="["SwiftUI", "iOS", "Combine"]"><meta name="description" content="自加载View"><meta name="og:description" content="自加载View"><meta property="og:url" content="https://pfcstyle.github.io/2021/03/14/handling-loading-states-within-swiftui-views/"><meta property="og:site_name" content="01手记"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2021-03-14"> <script src="https://cdn.jsdelivr.net/gh/pfcstyle/pfcstyle.github.io@master/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/pfcstyle/pfcstyle.github.io@master/assets/js/jquery-ui.js"></script> <script src="https://cdn.jsdelivr.net/gh/pfcstyle/pfcstyle.github.io@master/assets/js/main.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://pfcstyle.github.io/" title="01手记"><span class="octicon octicon-mark-github"></span> 01手记</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://pfcstyle.github.io/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="https://pfcstyle.github.io/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="https://pfcstyle.github.io/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="https://pfcstyle.github.io/links/" class=" site-header-nav-item" target="" title="链接">链接</a> <a href="https://pfcstyle.github.io/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="Loading states "><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">Loading states of SwiftUI views</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2021/03/14 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://pfcstyle.github.io/categories/#SwfitUI" title="SwfitUI">SwfitUI</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 6450 字，约 19 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><h1 id="自加载view">自加载View</h1><p>这是一种最为简单的情况，在view中调用异步数据加载并更新到view上去。下面的实例代码中，我们假设有一个异步的loader,通过view的生命周期函数调用loader并更新。</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">ArticleView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">articleID</span><span class="p">:</span> <span class="kt">Article</span><span class="o">.</span><span class="kt">ID</span>
    <span class="k">var</span> <span class="nv">loader</span><span class="p">:</span> <span class="kt">ArticleLoader</span>
    
    <span class="kd">@State</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">Result</span><span class="o">&lt;</span><span class="kt">Article</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span><span class="p">?</span>

    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">article</span><span class="p">):</span>
            <span class="c1">// Rendering our article content within a scroll view:</span>
            <span class="kt">ScrollView</span> <span class="p">{</span>
                <span class="kt">VStack</span><span class="p">(</span><span class="nv">spacing</span><span class="p">:</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kt">Text</span><span class="p">(</span><span class="n">article</span><span class="o">.</span><span class="n">title</span><span class="p">)</span><span class="o">.</span><span class="nf">font</span><span class="p">(</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
                    <span class="kt">Text</span><span class="p">(</span><span class="n">article</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="o">.</span><span class="nf">padding</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
            <span class="c1">// Showing any error that was encountered using a</span>
            <span class="c1">// dedicated ErrorView, which runs a given closure</span>
            <span class="c1">// when the user tapped an embedded "Retry" button:</span>
            <span class="kt">ErrorView</span><span class="p">(</span><span class="nv">error</span><span class="p">:</span> <span class="n">error</span><span class="p">,</span> <span class="nv">retryHandler</span><span class="p">:</span> <span class="n">loadArticle</span><span class="p">)</span>
        <span class="k">case</span> <span class="nv">nil</span><span class="p">:</span>
            <span class="c1">// We display a classic loading spinner while we're</span>
            <span class="c1">// waiting for our content to load, and we start our</span>
            <span class="c1">// loading operation once that view appears:</span>
            <span class="kt">ProgressView</span><span class="p">()</span><span class="o">.</span><span class="nf">onAppear</span><span class="p">(</span><span class="nv">perform</span><span class="p">:</span> <span class="n">loadArticle</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">loadArticle</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">loader</span><span class="o">.</span><span class="nf">loadArticle</span><span class="p">(</span><span class="nv">withID</span><span class="p">:</span> <span class="n">articleID</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nv">$0</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h1 id="viewmodel">ViewModel</h1><p>但是上面不是一种好的方式，因为当我们有更多的异步请求时，这些代码就会变得非常混乱，甚至出现很多层case嵌套的情况。这时候，ArticleViewModel就可以出场了，它本质是一个ObservableObject。</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">ArticleViewModel</span><span class="p">:</span> <span class="kt">ObservableObject</span> <span class="p">{</span>
    <span class="kd">enum</span> <span class="kt">State</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">idle</span>
        <span class="k">case</span> <span class="n">loading</span>
        <span class="k">case</span> <span class="nf">failed</span><span class="p">(</span><span class="kt">Error</span><span class="p">)</span>
        <span class="k">case</span> <span class="nf">loaded</span><span class="p">(</span><span class="kt">Article</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">@Published</span> <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">state</span> <span class="o">=</span> <span class="kt">State</span><span class="o">.</span><span class="n">idle</span>
    
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">articleID</span><span class="p">:</span> <span class="kt">Article</span><span class="o">.</span><span class="kt">ID</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">loader</span><span class="p">:</span> <span class="kt">ArticleLoader</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">articleID</span><span class="p">:</span> <span class="kt">Article</span><span class="o">.</span><span class="kt">ID</span><span class="p">,</span> <span class="nv">loader</span><span class="p">:</span> <span class="kt">ArticleLoader</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">articleID</span> <span class="o">=</span> <span class="n">articleID</span>
        <span class="k">self</span><span class="o">.</span><span class="n">loader</span> <span class="o">=</span> <span class="n">loader</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">load</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">state</span> <span class="o">=</span> <span class="o">.</span><span class="n">loading</span>

        <span class="n">loader</span><span class="o">.</span><span class="nf">loadArticle</span><span class="p">(</span><span class="nv">withID</span><span class="p">:</span> <span class="n">articleID</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">result</span> <span class="k">in</span>
            <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">article</span><span class="p">):</span>
                <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="o">.</span><span class="nf">loaded</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
            <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
                <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="o">.</span><span class="nf">failed</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>接下来，我们使用@ObservedObject属性包装器来使用这个ViewModel</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">ArticleView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="kd">@ObservedObject</span> <span class="k">var</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="kt">ArticleViewModel</span>

    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="n">viewModel</span><span class="o">.</span><span class="n">state</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">idle</span><span class="p">:</span>
            <span class="c1">// Render a clear color and start the loading process</span>
            <span class="c1">// when the view first appears, which should make the</span>
            <span class="c1">// view model transition into its loading state:</span>
            <span class="kt">Color</span><span class="o">.</span><span class="n">clear</span><span class="o">.</span><span class="nf">onAppear</span><span class="p">(</span><span class="nv">perform</span><span class="p">:</span> <span class="n">viewModel</span><span class="o">.</span><span class="n">load</span><span class="p">)</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">loading</span><span class="p">:</span>
            <span class="kt">ProgressView</span><span class="p">()</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">failed</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
            <span class="kt">ErrorView</span><span class="p">(</span><span class="nv">error</span><span class="p">:</span> <span class="n">error</span><span class="p">,</span> <span class="nv">retryHandler</span><span class="p">:</span> <span class="n">viewModel</span><span class="o">.</span><span class="n">load</span><span class="p">)</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">loaded</span><span class="p">(</span><span class="k">let</span> <span class="nv">article</span><span class="p">):</span>
            <span class="kt">ScrollView</span> <span class="p">{</span>
                <span class="kt">VStack</span><span class="p">(</span><span class="nv">spacing</span><span class="p">:</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kt">Text</span><span class="p">(</span><span class="n">article</span><span class="o">.</span><span class="n">title</span><span class="p">)</span><span class="o">.</span><span class="nf">font</span><span class="p">(</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
                    <span class="kt">Text</span><span class="p">(</span><span class="n">article</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="o">.</span><span class="nf">padding</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h1 id="通用模型封装">通用模型封装</h1><p>上面我们已经成功地将网络请求逻辑和视图地更新逻辑分离开了，这让我们可以更加专注地投入与对应地逻辑开发中。接下来我们可以更近一步，从中抽象出一套异步请求通用的模式出来。</p><h2 id="状态封装">状态封装</h2><p>首先我们发现State枚举其实不止适用于Article，对于所有的异步请求几乎都适用。</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">enum</span> <span class="kt">LoadingState</span><span class="o">&lt;</span><span class="kt">Value</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">idle</span>
    <span class="k">case</span> <span class="n">loading</span>
    <span class="k">case</span> <span class="nf">failed</span><span class="p">(</span><span class="kt">Error</span><span class="p">)</span>
    <span class="k">case</span> <span class="nf">loaded</span><span class="p">(</span><span class="kt">Value</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="loadableobject">LoadableObject</h2><p>接下来，我们从ArticleViewModel中抽象出加载数据的ViewModel的通用模型</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">LoadableObject</span><span class="p">:</span> <span class="kt">ObservableObject</span> <span class="p">{</span>
    <span class="kd">associatedtype</span> <span class="kt">Output</span>
    <span class="k">var</span> <span class="nv">state</span><span class="p">:</span> <span class="kt">LoadingState</span><span class="o">&lt;</span><span class="kt">Output</span><span class="o">&gt;</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    <span class="kd">func</span> <span class="nf">load</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div><h1 id="asynccontentview">AsyncContentView</h1><p>到这里结束了吗？其实还没有，我们同样可以对适用异步请求的View进行统一抽象。这样我们就可以统一对我们的加载视图进行管理了。</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">AsyncContentView</span><span class="o">&lt;</span><span class="kt">Source</span><span class="p">:</span> <span class="kt">LoadableObject</span><span class="p">,</span> <span class="kt">Content</span><span class="p">:</span> <span class="kt">View</span><span class="o">&gt;</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="kd">@ObservedObject</span> <span class="k">var</span> <span class="nv">source</span><span class="p">:</span> <span class="kt">Source</span>
    <span class="k">var</span> <span class="nv">content</span><span class="p">:</span> <span class="p">(</span><span class="kt">Source</span><span class="o">.</span><span class="kt">Output</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Content</span>

    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="n">source</span><span class="o">.</span><span class="n">state</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">idle</span><span class="p">:</span>
            <span class="kt">Color</span><span class="o">.</span><span class="n">clear</span><span class="o">.</span><span class="nf">onAppear</span><span class="p">(</span><span class="nv">perform</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">load</span><span class="p">)</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">loading</span><span class="p">:</span>
            <span class="kt">ProgressView</span><span class="p">()</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">failed</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
            <span class="kt">ErrorView</span><span class="p">(</span><span class="nv">error</span><span class="p">:</span> <span class="n">error</span><span class="p">,</span> <span class="nv">retryHandler</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">load</span><span class="p">)</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">loaded</span><span class="p">(</span><span class="k">let</span> <span class="nv">output</span><span class="p">):</span>
            <span class="nf">content</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>这样我们只需要对每一个content闭包返回一个单视图，就可以很完美的工作了。不过，我们还可以做的更好一点，那就是使用@ViewBuilder属性包装器来让这闭包可以支持完整的SwfitUI’s DSL功能了</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">AsyncContentView</span><span class="o">&lt;</span><span class="kt">Source</span><span class="p">:</span> <span class="kt">LoadableObject</span><span class="p">,</span> <span class="kt">Content</span><span class="p">:</span> <span class="kt">View</span><span class="o">&gt;</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="kd">@ObservedObject</span> <span class="k">var</span> <span class="nv">source</span><span class="p">:</span> <span class="kt">Source</span>
    <span class="k">var</span> <span class="nv">content</span><span class="p">:</span> <span class="p">(</span><span class="kt">Source</span><span class="o">.</span><span class="kt">Output</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Content</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">source</span><span class="p">:</span> <span class="kt">Source</span><span class="p">,</span>
         <span class="kd">@ViewBuilder</span> <span class="nv">content</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Source</span><span class="o">.</span><span class="kt">Output</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Content</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="k">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
    <span class="p">}</span>
    
    <span class="o">...</span>
<span class="p">}</span>
</code></pre></div></div><p>接下来我们看如何使用,重新实现ArticleView</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">ArticleView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="kd">@ObservedObject</span> <span class="k">var</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="kt">ArticleViewModel</span>

    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">AsyncContentView</span><span class="p">(</span><span class="nv">source</span><span class="p">:</span> <span class="n">viewModel</span><span class="p">)</span> <span class="p">{</span> <span class="n">article</span> <span class="k">in</span>
            <span class="kt">ScrollView</span> <span class="p">{</span>
                <span class="kt">VStack</span><span class="p">(</span><span class="nv">spacing</span><span class="p">:</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kt">Text</span><span class="p">(</span><span class="n">article</span><span class="o">.</span><span class="n">title</span><span class="p">)</span><span class="o">.</span><span class="nf">font</span><span class="p">(</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
                    <span class="kt">Text</span><span class="p">(</span><span class="n">article</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="o">.</span><span class="nf">padding</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h1 id="combine--swfitui">Combine + SwfitUI</h1><p>SwiftUI经常会与Combine一起适配使用，因为这两个框架都遵循非常相似的声明式语法和数据驱动设计模式。</p><p>所以，与其让我们的视图遵循经典的单次一对一加载渲染模式，不如使用数据驱动的模式，来让数据随着app的状态变化可以持续的反馈到视图去,这就是flux。</p><p>接下来，我们使用Combine publisher来实现LoadableObject，然后使用其来加载和更新发布的状态。</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">PublishedObject</span><span class="o">&lt;</span><span class="kt">Wrapped</span><span class="p">:</span> <span class="kt">Publisher</span><span class="o">&gt;</span><span class="p">:</span> <span class="kt">LoadableObject</span> <span class="p">{</span>
    <span class="kd">@Published</span> <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">state</span> <span class="o">=</span> <span class="kt">LoadingState</span><span class="o">&lt;</span><span class="kt">Wrapped</span><span class="o">.</span><span class="kt">Output</span><span class="o">&gt;.</span><span class="n">idle</span>

    <span class="kd">private</span> <span class="k">let</span> <span class="nv">publisher</span><span class="p">:</span> <span class="kt">Wrapped</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">cancellable</span><span class="p">:</span> <span class="kt">AnyCancellable</span><span class="p">?</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">publisher</span><span class="p">:</span> <span class="kt">Wrapped</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">publisher</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">load</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">state</span> <span class="o">=</span> <span class="o">.</span><span class="n">loading</span>

        <span class="n">cancellable</span> <span class="o">=</span> <span class="n">publisher</span>
            <span class="o">.</span><span class="nf">map</span><span class="p">(</span><span class="kt">LoadingState</span><span class="o">.</span><span class="n">loaded</span><span class="p">)</span>
            <span class="o">.</span><span class="k">catch</span> <span class="p">{</span> <span class="n">error</span> <span class="k">in</span>
                <span class="kt">Just</span><span class="p">(</span><span class="kt">LoadingState</span><span class="o">.</span><span class="nf">failed</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
            <span class="p">}</span>
            <span class="o">.</span><span class="n">sink</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">state</span> <span class="k">in</span>
                <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>
            <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>接下来，通过Swift的泛型能力，我们队AsyncContentView进行改造。</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">AsyncContentView</span> <span class="p">{</span>
    <span class="kd">init</span><span class="o">&lt;</span><span class="kt">P</span><span class="p">:</span> <span class="kt">Publisher</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="nv">source</span><span class="p">:</span> <span class="kt">P</span><span class="p">,</span>
        <span class="kd">@ViewBuilder</span> <span class="nv">content</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">P</span><span class="o">.</span><span class="kt">Output</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Content</span>
    <span class="p">)</span> <span class="k">where</span> <span class="kt">Source</span> <span class="o">==</span> <span class="kt">PublishedObject</span><span class="o">&lt;</span><span class="kt">P</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span>
            <span class="nv">source</span><span class="p">:</span> <span class="kt">PublishedObject</span><span class="p">(</span><span class="nv">publisher</span><span class="p">:</span> <span class="n">source</span><span class="p">),</span>
            <span class="nv">content</span><span class="p">:</span> <span class="n">content</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>再看下ArticleView如何实现。</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">ArticleView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">publisher</span><span class="p">:</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Article</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span>

    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">AsyncContentView</span><span class="p">(</span><span class="nv">source</span><span class="p">:</span> <span class="n">publisher</span><span class="p">)</span> <span class="p">{</span> <span class="n">article</span> <span class="k">in</span>
            <span class="kt">ScrollView</span> <span class="p">{</span>
                <span class="kt">VStack</span><span class="p">(</span><span class="nv">spacing</span><span class="p">:</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kt">Text</span><span class="p">(</span><span class="n">article</span><span class="o">.</span><span class="n">title</span><span class="p">)</span><span class="o">.</span><span class="nf">font</span><span class="p">(</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
                    <span class="kt">Text</span><span class="p">(</span><span class="n">article</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="o">.</span><span class="nf">padding</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="kd">struct</span> <span class="kt">ArticleListView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="kd">@ObservedObject</span> <span class="k">var</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="kt">ArticleListViewModel</span>
    
    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">List</span><span class="p">(</span><span class="n">viewModel</span><span class="o">.</span><span class="n">articlePreviews</span><span class="p">)</span> <span class="p">{</span> <span class="n">preview</span> <span class="k">in</span>
            <span class="kt">NavigationLink</span><span class="p">(</span><span class="n">preview</span><span class="o">.</span><span class="n">title</span>
                <span class="nv">destination</span><span class="p">:</span> <span class="kt">ArticleView</span><span class="p">(</span>
                    <span class="nv">publisher</span><span class="p">:</span> <span class="n">viewModel</span><span class="o">.</span><span class="nf">publisher</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">preview</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>大家可能会疑惑loader去哪里了，什么时候加载数据呢？实际上，在这里publisher取代了loader的位置，这里就要求你的网络请求需要返回一个publisher对象，而这，恰恰是当下比较流行的网络加载库已经做好的事。</p><h1 id="支持自定义的loading-view">支持自定义的Loading View</h1><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">AsyncContentView</span><span class="o">&lt;</span><span class="kt">Source</span><span class="p">:</span> <span class="kt">LoadableObject</span><span class="p">,</span>
                        <span class="kt">LoadingView</span><span class="p">:</span> <span class="kt">View</span><span class="p">,</span>
                        <span class="kt">Content</span><span class="p">:</span> <span class="kt">View</span><span class="o">&gt;</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="kd">@ObservedObject</span> <span class="k">var</span> <span class="nv">source</span><span class="p">:</span> <span class="kt">Source</span>
    <span class="k">var</span> <span class="nv">loadingView</span><span class="p">:</span> <span class="kt">LoadingView</span>
    <span class="k">var</span> <span class="nv">content</span><span class="p">:</span> <span class="p">(</span><span class="kt">Source</span><span class="o">.</span><span class="kt">Output</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Content</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">source</span><span class="p">:</span> <span class="kt">Source</span><span class="p">,</span>
         <span class="nv">loadingView</span><span class="p">:</span> <span class="kt">LoadingView</span><span class="p">,</span>
         <span class="kd">@ViewBuilder</span> <span class="nv">content</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Source</span><span class="o">.</span><span class="kt">Output</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Content</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="k">self</span><span class="o">.</span><span class="n">loadingView</span> <span class="o">=</span> <span class="n">loadingView</span>
        <span class="k">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
    <span class="p">}</span>

    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="n">source</span><span class="o">.</span><span class="n">state</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">idle</span><span class="p">:</span>
            <span class="kt">Color</span><span class="o">.</span><span class="n">clear</span><span class="o">.</span><span class="nf">onAppear</span><span class="p">(</span><span class="nv">perform</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">load</span><span class="p">)</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">loading</span><span class="p">:</span>
            <span class="n">loadingView</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">failed</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
            <span class="kt">ErrorView</span><span class="p">(</span><span class="nv">error</span><span class="p">:</span> <span class="n">error</span><span class="p">,</span> <span class="nv">retryHandler</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">load</span><span class="p">)</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">loaded</span><span class="p">(</span><span class="k">let</span> <span class="nv">output</span><span class="p">):</span>
            <span class="nf">content</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 为了更进一步的方便使用，我们通过extension来增加默认加载视图地能力。</span>
<span class="kd">typealias</span> <span class="kt">DefaultProgressView</span> <span class="o">=</span> <span class="kt">ProgressView</span><span class="o">&lt;</span><span class="kt">EmptyView</span><span class="p">,</span> <span class="kt">EmptyView</span><span class="o">&gt;</span>

<span class="kd">extension</span> <span class="kt">AsyncContentView</span> <span class="k">where</span> <span class="kt">LoadingView</span> <span class="o">==</span> <span class="kt">DefaultProgressView</span> <span class="p">{</span>
    <span class="nf">init</span><span class="p">(</span>
        <span class="nv">source</span><span class="p">:</span> <span class="kt">Source</span><span class="p">,</span>
        <span class="kd">@ViewBuilder</span> <span class="nv">content</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Source</span><span class="o">.</span><span class="kt">Output</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Content</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span>
            <span class="nv">source</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span>
            <span class="nv">loadingView</span><span class="p">:</span> <span class="kt">ProgressView</span><span class="p">(),</span>
            <span class="nv">content</span><span class="p">:</span> <span class="n">content</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>最后，我们再看看ArticleView。我们为其添加了自定义的占位加载视图，在Article加载时，就可以显示我们自定义的占位图。</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">ArticleView</span> <span class="p">{</span>
    <span class="kd">struct</span> <span class="kt">ContentView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">article</span><span class="p">:</span> <span class="kt">Article</span>

        <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
            <span class="kt">VStack</span><span class="p">(</span><span class="nv">spacing</span><span class="p">:</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">Text</span><span class="p">(</span><span class="n">article</span><span class="o">.</span><span class="n">title</span><span class="p">)</span><span class="o">.</span><span class="nf">font</span><span class="p">(</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
                <span class="kt">Text</span><span class="p">(</span><span class="n">article</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="o">.</span><span class="nf">padding</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">struct</span> <span class="kt">Placeholder</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
            <span class="kt">ContentView</span><span class="p">(</span><span class="nv">article</span><span class="p">:</span> <span class="kt">Article</span><span class="p">(</span>
                <span class="nv">title</span><span class="p">:</span> <span class="s">"Title"</span><span class="p">,</span>
                <span class="nv">body</span><span class="p">:</span> <span class="kt">String</span><span class="p">(</span><span class="nv">repeating</span><span class="p">:</span> <span class="s">"Body"</span><span class="p">,</span> <span class="nv">count</span><span class="p">:</span> <span class="mi">100</span><span class="p">)</span>
            <span class="p">))</span><span class="o">.</span><span class="nf">redacted</span><span class="p">(</span><span class="nv">reason</span><span class="p">:</span> <span class="o">.</span><span class="n">placeholder</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">ArticleView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">publisher</span><span class="p">:</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Article</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span>

    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">ScrollView</span> <span class="p">{</span>
            <span class="kt">AsyncContentView</span><span class="p">(</span>
                <span class="nv">source</span><span class="p">:</span> <span class="n">publisher</span><span class="p">,</span>
                <span class="nv">loadingView</span><span class="p">:</span> <span class="kt">Placeholder</span><span class="p">(),</span>
                <span class="nv">content</span><span class="p">:</span> <span class="kt">ContentView</span><span class="o">.</span><span class="kd">init</span>
            <span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>最后的最后，这是MVVM设计模式吗？ 答案是：是的。这就是MVVM，只是我们这里并没有给出Article Model的实现。</p><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://pfcstyle.github.io" target="_blank">Yawei Wang</a></li><li>本文链接：<a href="https://pfcstyle.github.io/2021/03/14/handling-loading-states-within-swiftui-views/" target="_blank">https://pfcstyle.github.io/2021/03/14/handling-loading-states-within-swiftui-views/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/pfcstyle/pfcstyle.github.io@master/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/2021/03/14/handling-loading-states-within-swiftui', clientID: 'e1a31f938861348e8751', clientSecret: 'd911850947298eb91753591eeb8dba129cc7fd86', repo: 'bomment', owner: 'pfcstyle', admin: ['pfcstyle'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://cdn.jsdelivr.net/gh/pfcstyle/pfcstyle.github.io@master/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://pfcstyle.github.io/assets/search_data.json', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://cdn.jsdelivr.net/gh/pfcstyle/pfcstyle.github.io@master/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2015 <span title="Yawei Wang">Yawei Wang</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/pfcstyle/pfcstyle.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://pfcstyle.github.io/" title="首页" target="">首页</a></li><li> <a href="https://pfcstyle.github.io/categories/" title="分类" target="">分类</a></li><li> <a href="https://pfcstyle.github.io/wiki/" title="维基" target="">维基</a></li><li> <a href="https://pfcstyle.github.io/links/" title="链接" target="">链接</a></li><li> <a href="https://pfcstyle.github.io/about/" title="关于" target="">关于</a></li><li><a href="https://pfcstyle.github.io/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul><script async src="https://cdn.jsdelivr.net/gh/pfcstyle/pfcstyle.github.io@master/assets/vendor/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="mobile-hidden" style="margin-top:8px"> <span id="busuanzi_container_site_pv" style="display:none"> 本站访问量<span id="busuanzi_value_site_pv"></span>次 </span> <span id="busuanzi_container_site_uv" style="display:none"> / 本站访客数<span id="busuanzi_value_site_uv"></span>人 </span> <span id="busuanzi_container_page_pv" style="display:none"> / 本页访问量<span id="busuanzi_value_page_pv"></span>次 / 统计始于2020-05-03 </span></div></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://cdn.jsdelivr.net/gh/pfcstyle/pfcstyle.github.io@master/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script><div style="display:none"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-80669434-1', 'auto'); ga('send', 'pageview'); </script></div></body></html>
